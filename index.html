<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYBSA 회원 검색</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Sheets는 CSV 형식으로 직접 로드하므로 XLSX는 로컬 파일 선택 시에만 사용 -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .qr-button {
            padding: 15px 20px;
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }

        .qr-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 198, 239, 0.4);
        }

        .qr-button:active {
            transform: translateY(0);
        }

        .qr-button svg {
            width: 24px;
            height: 24px;
        }

        /* QR 스캔 모달 */
        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .qr-modal.active {
            display: flex;
        }

        .qr-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .qr-scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        #qr-reader {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
        }

        .qr-modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .qr-modal-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .qr-modal-header p {
            color: #666;
            font-size: 14px;
        }

        .qr-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .qr-modal-close:hover {
            background: #e0e0e0;
        }

        .qr-status {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .qr-status.scanning {
            background: #e3f2fd;
            color: #1976d2;
        }

        .qr-status.success {
            background: #e8f5e9;
            color: #388e3c;
        }

        .qr-status.error {
            background: #ffebee;
            color: #c62828;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .result.hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #666;
            margin-top: 20px;
        }

        .file-input-wrapper {
            margin-bottom: 20px;
            text-align: center;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #f0f0f0;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input-label:hover {
            background: #e0e0e0;
        }

        input[type="file"] {
            display: none;
        }

        .info {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        .similar-names {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .similar-names.hidden {
            display: none;
        }

        .similar-names h3 {
            font-size: 16px;
            color: #495057;
            margin-bottom: 10px;
        }

        .similar-names ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .similar-names li {
            padding: 12px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .similar-item-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .similar-item-details {
            font-size: 13px;
            color: #495057;
            line-height: 1.6;
        }

        .similar-item-details div {
            margin: 4px 0;
            padding: 4px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .similar-item-details div:last-child {
            border-bottom: none;
        }

        .similarity-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        .edit-panel {
            margin-top: 20px;
            padding: 15px;
            background: #fff7e6;
            border-radius: 10px;
            border: 1px solid #ffe0b3;
        }

        .edit-panel.hidden {
            display: none;
        }

        .edit-panel h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #d48806;
        }

        .edit-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }

        .edit-row label {
            font-size: 14px;
            color: #555;
            text-align: right;
            padding-right: 8px;
        }

        .edit-row input {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            width: 50%;
            justify-self: start;
        }

        .edit-actions {
            margin-top: 10px;
            text-align: right;
        }

        .edit-note {
            font-size: 12px;
            color: #888;
            margin-bottom: 8px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            max-width: 120px;
            height: auto;
            margin: 0 auto;
            display: block;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 1;
                filter: brightness(1);
                transform: scale(1);
            }
            25% {
                opacity: 0.8;
                filter: brightness(1.3);
                transform: scale(1.02);
            }
            50% {
                opacity: 1;
                filter: brightness(1.5);
                transform: scale(1.05);
            }
            75% {
                opacity: 0.9;
                filter: brightness(1.2);
                transform: scale(1.02);
            }
        }

        /* 모바일 반응형 스타일 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .container {
                padding: 20px;
                border-radius: 15px;
                max-width: 100%;
            }

            h1 {
                font-size: 22px;
                margin-bottom: 20px;
            }

            .logo {
                max-width: 100px;
            }

            .search-box {
                flex-direction: column;
                gap: 10px;
            }

            .search-box > div {
                display: flex;
                gap: 10px;
                width: 100%;
            }

            input[type="text"] {
                padding: 12px;
                font-size: 16px; /* iOS 줌 방지 */
            }

            button {
                padding: 12px 20px;
                font-size: 16px;
                flex: 1;
            }

            .qr-button {
                padding: 12px 20px;
                flex: 0 0 auto;
                min-width: 60px;
            }

            .qr-modal-content {
                padding: 20px;
                max-width: 95%;
            }

            .result {
                padding: 15px;
                font-size: 16px;
                min-height: 50px;
            }

            .similar-names {
                padding: 12px;
            }

            .similar-names h3 {
                font-size: 14px;
            }

            .similar-names li {
                padding: 10px;
                margin: 6px 0;
            }

            .similar-item-header {
                font-size: 14px;
            }

            .similar-item-details {
                font-size: 12px;
            }

            .edit-panel {
                padding: 12px;
            }

            .edit-panel h3 {
                font-size: 14px;
            }

            .edit-row {
                grid-template-columns: 80px 1fr;
                gap: 8px;
                margin-bottom: 10px;
            }

            .edit-row label {
                font-size: 13px;
                text-align: left;
                padding-right: 0;
            }

            .edit-row input {
                width: 100%;
                padding: 8px;
                font-size: 16px; /* iOS 줌 방지 */
                justify-self: stretch;
            }

            .edit-actions {
                margin-top: 15px;
            }

            .edit-actions button {
                width: 100%;
                padding: 12px;
            }

            .file-input-label {
                padding: 10px 16px;
                font-size: 14px;
            }

            .info {
                font-size: 12px;
                margin-top: 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 20px;
            }

            .logo {
                max-width: 80px;
            }

            .edit-row {
                grid-template-columns: 70px 1fr;
                gap: 6px;
            }

            .edit-row label {
                font-size: 12px;
            }

            .similar-item-header {
                font-size: 13px;
            }

            .similar-item-details {
                font-size: 11px;
            }
        }
    </style>
    <!-- PWA 설정 -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#667eea">

<!-- iOS 홈화면 대응 -->
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="NYBSA 검색">
<link rel="apple-touch-icon" href="icon-192.png">

</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://static.wixstatic.com/media/e9143e_4bd1538969c44e5aa3541e2cf2051b30~mv2.png" alt="NYBSA 로고" class="logo">
        </div>
        <h1>NYBSA 회원 검색</h1>
        
        <div class="file-input-wrapper">
            <label for="excelFile" class="file-input-label">
                Excel 파일 선택 (선택사항 - Google Sheets 자동 로드)
            </label>
            <input type="file" id="excelFile" accept=".xlsx,.xls" />
        </div>

        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="회원이름 또는 상호명을 입력하세요"
                onkeypress="if(event.key === 'Enter') searchMember()"
            />
            <div style="display: flex; gap: 10px;">
                <button class="qr-button" onclick="openQRScanner()" title="QR 코드 스캔">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                    </svg>
                </button>
                <button onclick="searchMember()">검색</button>
            </div>
        </div>

        <div id="loading" class="loading hidden"></div>
        
        <div id="result" class="result hidden"></div>

        <div id="similarNames" class="similar-names hidden">
            <h3>유사한 이름 (클릭해서 편집):</h3>
            <ul id="similarNamesList"></ul>
        </div>

        <div id="editPanel" class="edit-panel hidden">
            <h3>회비 / 티켓 / 참석 / 수금 정보 수정</h3>
            <div class="edit-note">위 목록에서 회원을 클릭하면 아래 항목을 수정할 수 있습니다.</div>
            <div class="edit-row">
                <label>지역</label>
                <div id="editRegion"></div>
            </div>
            <div class="edit-row">
                <label>업소명</label>
                <div id="editStore"></div>
            </div>
            <div class="edit-row">
                <label>이름</label>
                <div id="editName"></div>
            </div>
            <div class="edit-row">
                <label for="feeInput">회비</label>
                <input id="feeInput" type="text" />
            </div>
            <div class="edit-row">
                <label for="ticketInput">티켓</label>
                <input id="ticketInput" type="text" />
            </div>
            <div class="edit-row">
                <label for="attendInput">참석인원</label>
                <input id="attendInput" type="text" />
            </div>
            <div class="edit-row">
                <label for="payMethodInput">수금방식</label>
                <input id="payMethodInput" type="text" />
            </div>
            <div class="edit-row">
                <label for="collectorInput">수금자</label>
                <input id="collectorInput" type="text" />
            </div>
            <div class="edit-actions">
                <button onclick="saveToGoogleSheets()">Google Sheets에 저장</button>
            </div>
            <!-- 원본 rowData를 저장하는 숨겨진 필드 -->
            <input type="hidden" id="originalRowData" />
        </div>

        <div class="info">
            Google Sheets에서 자동으로 데이터를 불러옵니다. 필요시 Excel 파일을 직접 선택할 수도 있습니다.
        </div>
    </div>

    <!-- QR 코드 스캔 모달 -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <button class="qr-modal-close" onclick="closeQRScanner()">&times;</button>
            <div class="qr-modal-header">
                <h2>QR 코드 스캔</h2>
                <p>QR 코드를 카메라에 맞춰주세요</p>
            </div>
            <div class="qr-scanner-container">
                <div id="qr-reader"></div>
                <div id="qr-status" class="qr-status scanning">카메라를 시작하는 중...</div>
            </div>
        </div>
    </div>

    <script>
        let memberData = [];
        let isDataLoaded = false;
        let currentEditRowIndex = null; // Google Sheets에서 수정할 행 인덱스 (데이터 기준, 헤더 제외)
        let headerRemoved = false; // 헤더가 제거되었는지 여부
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZWeUb9odP4SmBnxxc1v-momH4TEnF3x5XNyqQ3aFEF4pLCUkLnMtsu5czcNhmpg7F7A/exec';
        let html5QrcodeScanner = null; // QR 코드 스캐너 인스턴스
        let isQRScannerRunning = false; // QR 스캐너 실행 상태 추적

        // 페이지 로드 시 Google Sheets 자동 로드
        window.addEventListener('DOMContentLoaded', async () => {
            await loadGoogleSheets();
        });

        // 타임아웃이 있는 fetch 함수
        async function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'default', // 캐시 사용으로 속도 개선
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        }

        // Google Sheets에서 데이터 로드 (최적화된 버전)
        async function loadGoogleSheets(background = false) {
            const sheetId = '1VO1J_ShBYQWBOt_NKLpK4xhlaqcCqjV5PNpspDrA5mI';
            const CACHE_KEY = `sheets_data_${sheetId}`;
            const CACHE_DURATION = 5 * 60 * 1000; // 5분 캐시
            
            // 캐시된 데이터 확인 (백그라운드 모드가 아닐 때만)
            if (!background) {
                try {
                    const cached = localStorage.getItem(CACHE_KEY);
                    if (cached) {
                        const { data, timestamp } = JSON.parse(cached);
                        if (Date.now() - timestamp < CACHE_DURATION) {
                            memberData = data;
                            isDataLoaded = true;
                            showLoading(false);
                            console.log('캐시에서 데이터 로드 완료:', memberData.length, '행');
                            showResult('Google Sheets 데이터가 성공적으로 로드되었습니다. (캐시)', 'success');
                            setTimeout(() => {
                                const resultDiv = document.getElementById('result');
                                resultDiv.classList.add('hidden');
                            }, 1500);
                            // 백그라운드에서 최신 데이터 가져오기
                            loadGoogleSheets(true);
                            return;
                        }
                    }
                } catch (e) {
                    console.log('캐시 읽기 실패, 새로 로드합니다.');
                }
            }
            
            if (!background) {
                showLoading(true);
            }
            
            // 여러 방법을 병렬로 시도 (가장 빠른 응답 사용)
            const directUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`;
            const proxyUrls = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(directUrl)}`,
                `https://corsproxy.io/?${encodeURIComponent(directUrl)}`
            ];
            
            // 직접 URL을 먼저 시도 (가장 빠름)
            const allPromises = [
                fetchWithTimeout(directUrl, 5000).catch(e => ({ error: e, method: 'direct' }))
            ];
            
            // 프록시 URL들도 병렬로 시도
            proxyUrls.forEach((url, index) => {
                allPromises.push(
                    fetchWithTimeout(url, 5000).catch(e => ({ error: e, method: `proxy${index + 1}` }))
                );
            });
            
            let lastError = null;
            
            // Promise.race로 가장 빠른 성공 응답 사용
            const results = await Promise.allSettled(allPromises);
            
            for (let i = 0; i < results.length; i++) {
                const result = results[i];
                
                if (result.status === 'fulfilled' && !result.value.error) {
                    try {
                        const response = result.value;
                        
                        if (!response.ok) {
                            continue;
                        }
                        
                        const csvText = await response.text();
                        
                        if (!csvText || csvText.trim().length === 0) {
                            continue;
                        }
                        
                        // CSV를 파싱하여 배열로 변환
                        let parsedData = parseCSV(csvText);
                        
                        if (!parsedData || parsedData.length === 0) {
                            continue;
                        }
                        
                        // 첫 번째 행이 헤더인 경우 제거
                        if (parsedData.length > 0 && Array.isArray(parsedData[0])) {
                            const firstRow = parsedData[0];
                            if (firstRow.some(cell => typeof cell === 'string' && 
                                (cell.toLowerCase().includes('이름') || 
                                 cell.toLowerCase().includes('name') ||
                                 cell.toLowerCase().includes('id') ||
                                 cell.toLowerCase().includes('회원') ||
                                 cell.toLowerCase().includes('store') ||
                                 cell.toLowerCase().includes('address') ||
                                 cell.toLowerCase().includes('전화번호') ||
                                 cell.toLowerCase().includes('store name')))) {
                                parsedData = parsedData.slice(1);
                                headerRemoved = true;
                            }
                        }
                        
                        memberData = parsedData;
                        isDataLoaded = true;
                        
                        // 캐시에 저장
                        try {
                            localStorage.setItem(CACHE_KEY, JSON.stringify({
                                data: memberData,
                                timestamp: Date.now()
                            }));
                        } catch (e) {
                            console.log('캐시 저장 실패:', e);
                        }
                        
                        if (!background) {
                            showLoading(false);
                            console.log('Google Sheets 데이터 로드 완료:', memberData.length, '행');
                            showResult('Google Sheets 데이터가 성공적으로 로드되었습니다.', 'success');
                            setTimeout(() => {
                                const resultDiv = document.getElementById('result');
                                resultDiv.classList.add('hidden');
                            }, 1500);
                        } else {
                            console.log('백그라운드에서 데이터 업데이트 완료:', memberData.length, '행');
                        }
                        return; // 성공하면 함수 종료
                        
                    } catch (error) {
                        console.error(`방법 ${i + 1} 파싱 실패:`, error);
                        lastError = error;
                        continue;
                    }
                } else {
                    if (result.value && result.value.error) {
                        lastError = result.value.error;
                    }
                }
            }
            
            // 모든 방법 실패
            console.error('모든 방법 실패. 마지막 오류:', lastError);
            if (!background) {
                showLoading(false);
                showResult(`Google Sheets를 불러올 수 없습니다. 오류: ${lastError?.message || '알 수 없는 오류'}. 스프레드시트가 공개로 설정되어 있는지 확인해주세요.`, 'error');
            }
        }

        // CSV 파싱 함수 (개선된 버전)
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split(/\r?\n/); // Windows와 Unix 줄바꿈 모두 지원
            
            for (let lineIndex = 0; lineIndex < lines.length; lineIndex++) {
                let line = lines[lineIndex];
                
                // 빈 줄 건너뛰기
                if (line.trim() === '') continue;
                
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            // 이스케이프된 따옴표
                            current += '"';
                            i++; // 다음 따옴표 건너뛰기
                        } else {
                            // 따옴표 시작/끝
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        // 필드 구분자
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                // 마지막 필드 추가
                row.push(current.trim());
                
                // 빈 행이 아닌 경우만 추가
                if (row.some(cell => cell !== '')) {
                    rows.push(row);
                }
            }
            
            return rows;
        }

        // 로컬 파일 선택 시
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        memberData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // 헤더 제거 (필요한 경우)
                        if (memberData.length > 0 && Array.isArray(memberData[0])) {
                            const firstRow = memberData[0];
                            if (firstRow.some(cell => typeof cell === 'string' && 
                                (cell.toLowerCase().includes('이름') || 
                                 cell.toLowerCase().includes('name') ||
                                 cell.toLowerCase().includes('id') ||
                                 cell.toLowerCase().includes('회원')))) {
                                memberData = memberData.slice(1);
                            headerRemoved = true;
                            }
                        }
                        
                        isDataLoaded = true;
                        showResult('파일이 성공적으로 로드되었습니다.', 'success');
                        console.log('데이터 로드 완료:', memberData.length, '행');
                    } catch (error) {
                        console.error('파일 읽기 오류:', error);
                        showResult('파일을 읽는 중 오류가 발생했습니다.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // 전화번호 포맷팅 함수 (000-000-0000 형식)
        function formatPhoneNumber(phone) {
            if (!phone) return phone;
            
            // 숫자만 추출
            const numbers = String(phone).replace(/\D/g, '');
            
            // 10자리 또는 11자리인 경우에만 포맷팅
            if (numbers.length === 10) {
                return `${numbers.substring(0, 3)}-${numbers.substring(3, 6)}-${numbers.substring(6)}`;
            } else if (numbers.length === 11) {
                return `${numbers.substring(0, 3)}-${numbers.substring(3, 7)}-${numbers.substring(7)}`;
            }
            
            // 포맷팅할 수 없는 경우 원본 반환
            return phone;
        }

        // 문자열 유사도 계산 함수 (Levenshtein distance 기반)
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            
            str1 = String(str1).toLowerCase().trim();
            str2 = String(str2).toLowerCase().trim();
            
            if (str1 === str2) return 100;
            
            const len1 = str1.length;
            const len2 = str2.length;
            
            if (len1 === 0) return len2 === 0 ? 100 : 0;
            if (len2 === 0) return 0;
            
            // Levenshtein distance 계산
            const matrix = [];
            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }
            
            const distance = matrix[len1][len2];
            const maxLen = Math.max(len1, len2);
            const similarity = ((maxLen - distance) / maxLen) * 100;
            
            return similarity;
        }

        // 회원 검색 함수
        function searchMember() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            
            if (!searchTerm) {
                showResult('검색어를 입력해주세요.', 'error');
                hideSimilarNames();
                return;
            }

            if (!isDataLoaded || memberData.length === 0) {
                showResult('데이터가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.', 'error');
                hideSimilarNames();
                return;
            }

            const MIN_SIMILARITY = 60; // 60% 이상 유사도 필요
            let found = false;
            const similarItems = [];
            const processedRows = new Set(); // 중복 행 제거를 위한 Set

            // 모든 데이터에서 검색
            for (let rowIndex = 0; rowIndex < memberData.length; rowIndex++) {
                const row = memberData[rowIndex];
                let maxSimilarity = 0;
                let matchedCell = '';
                
                if (Array.isArray(row)) {
                    // 배열의 모든 셀에서 검색
                    for (let cell of row) {
                        if (cell) {
                            const similarity = calculateSimilarity(searchTerm, cell);
                            if (similarity >= MIN_SIMILARITY) {
                                found = true;
                                if (similarity > maxSimilarity) {
                                    maxSimilarity = similarity;
                                    matchedCell = String(cell).trim();
                                }
                            }
                        }
                    }
                    
                    // 유사도가 60% 이상인 행이면 전체 정보 저장
                    if (maxSimilarity >= MIN_SIMILARITY) {
                        // 행을 문자열로 변환하여 중복 체크
                        const rowKey = JSON.stringify(row);
                        if (!processedRows.has(rowKey)) {
                            processedRows.add(rowKey);
                            similarItems.push({
                                rowData: row,
                                similarity: maxSimilarity,
                                matchedValue: matchedCell,
                                rowIndex: rowIndex // Google Sheets에서 사용할 원본 행 인덱스
                            });
                        }
                    }
                } else if (typeof row === 'object') {
                    // 객체인 경우 모든 값에서 검색
                    for (let key in row) {
                        if (row[key]) {
                            const similarity = calculateSimilarity(searchTerm, row[key]);
                            if (similarity >= MIN_SIMILARITY) {
                                found = true;
                                if (similarity > maxSimilarity) {
                                    maxSimilarity = similarity;
                                    matchedCell = String(row[key]).trim();
                                }
                            }
                        }
                    }
                    
                    // 유사도가 60% 이상인 행이면 전체 정보 저장
                    if (maxSimilarity >= MIN_SIMILARITY) {
                        const rowKey = JSON.stringify(row);
                        if (!processedRows.has(rowKey)) {
                            processedRows.add(rowKey);
                            similarItems.push({
                                rowData: row,
                                similarity: maxSimilarity,
                                matchedValue: matchedCell,
                                rowIndex: rowIndex // Google Sheets에서 사용할 원본 행 인덱스
                            });
                        }
                    }
                }
            }

            // 유사도 순으로 정렬
            similarItems.sort((a, b) => b.similarity - a.similarity);

            // 결과 표시
            if (found) {
                showResult('NYBSA 회원입니다', 'success');
                showSimilarNames(similarItems);
            } else {
                showResult('데이터 베이스에서 검색결과가 없습니다', 'error');
                hideSimilarNames();
            }
        }

        // 유사한 이름 표시 함수
        function showSimilarNames(items) {
            const similarDiv = document.getElementById('similarNames');
            const similarList = document.getElementById('similarNamesList');
            
            if (items.length === 0) {
                hideSimilarNames();
                return;
            }
            
            similarList.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                
                // 헤더 부분 (매칭된 값과 유사도)
                const header = document.createElement('div');
                header.className = 'similar-item-header';
                header.innerHTML = `${item.matchedValue} <span class="similarity-badge">${Math.round(item.similarity)}% 유사</span>`;
                li.appendChild(header);
                
                // 상세 정보 부분 (행의 모든 데이터)
                const details = document.createElement('div');
                details.className = 'similar-item-details';
                
                if (Array.isArray(item.rowData)) {
                    // Google Sheets 컬럼 매핑: 지역-A, 업소명-B, 주소-C, 전화번호-D, 이름-E, 회비-F, 티켓-G, 참석인원-H, 수금방식-I, 수금자-J
                    const displayOrder = [
                        { index: 0, label: '지역' },           // A: 지역
                        { index: 1, label: '업소명' },         // B: 업소명
                        { index: 2, label: '주소' },           // C: 주소
                        { index: 3, label: '전화번호', format: 'phone' }, // D: 전화번호
                        { index: 4, label: '이름' },           // E: 이름
                        { index: 5, label: '회비' },           // F: 회비
                        { index: 6, label: '티켓' },           // G: 티켓
                        { index: 7, label: '참석인원' },       // H: 참석인원
                        { index: 8, label: '수금방식' },       // I: 수금방식
                        { index: 9, label: '수금자' }          // J: 수금자
                    ];
                    
                    // 요청한 순서대로 표시 (값이 없어도 표시)
                    displayOrder.forEach(col => {
                        const cell = item.rowData[col.index];
                        const detailDiv = document.createElement('div');
                        let displayValue = '';
                        
                        if (cell !== null && cell !== undefined && String(cell).trim() !== '') {
                            displayValue = col.format === 'phone' ? formatPhoneNumber(cell) : cell;
                        } else {
                            displayValue = '-'; // 값이 없으면 '-' 표시
                        }
                        
                        detailDiv.textContent = `${col.label}: ${displayValue}`;
                        details.appendChild(detailDiv);
                    });
                } else if (typeof item.rowData === 'object') {
                    // 객체인 경우 키-값 쌍으로 표시
                    for (let key in item.rowData) {
                        if (item.rowData[key] !== null && item.rowData[key] !== undefined && String(item.rowData[key]).trim() !== '') {
                            const detailDiv = document.createElement('div');
                            // 키가 전화번호 관련인 경우 포맷팅 적용
                            const isPhoneKey = key.toLowerCase().includes('전화') || key.toLowerCase().includes('phone') || key.toLowerCase().includes('tel');
                            const displayValue = isPhoneKey ? formatPhoneNumber(item.rowData[key]) : item.rowData[key];
                            detailDiv.textContent = `${key}: ${displayValue}`;
                            details.appendChild(detailDiv);
                        }
                    }
                }

                li.appendChild(details);

                // 클릭 시 편집 패널 열기
                li.style.cursor = 'pointer';
                li.addEventListener('click', () => {
                    openEditForm(item);
                });

                similarList.appendChild(li);
            });
            
            similarDiv.classList.remove('hidden');
        }

        // 유사한 이름 숨기기 함수
        function hideSimilarNames() {
            const similarDiv = document.getElementById('similarNames');
            similarDiv.classList.add('hidden');
        }

        // 결과 표시 함수
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = 'result ' + type;
            resultDiv.classList.remove('hidden');
        }

        // 로딩 표시 함수
        function showLoading(show) {
            const loadingDiv = document.getElementById('loading');
            if (show) {
                loadingDiv.classList.remove('hidden');
            } else {
                loadingDiv.classList.add('hidden');
            }
        }

        // 편집 폼 열기
        function openEditForm(item) {
            if (!Array.isArray(item.rowData)) {
                showResult('이 행은 편집할 수 없습니다.', 'error');
                return;
            }

            const row = item.rowData;
            
            // 방법 1: rowIndex가 있으면 직접 사용 (가장 확실)
            let foundIndex = -1;
            if (item.rowIndex !== undefined && item.rowIndex !== null) {
                foundIndex = item.rowIndex;
                console.log('rowIndex 직접 사용:', foundIndex);
            } else {
                // 방법 2: rowData를 직접 비교하여 memberData에서 정확한 인덱스 찾기
                console.log('rowData 비교로 인덱스 찾기 시도...');
                for (let i = 0; i < memberData.length; i++) {
                    if (Array.isArray(memberData[i])) {
                        // JSON.stringify로 전체 행 비교 (가장 정확)
                        const rowStr = JSON.stringify(row);
                        const memberStr = JSON.stringify(memberData[i]);
                        if (rowStr === memberStr) {
                            foundIndex = i;
                            console.log('JSON 비교로 찾음:', foundIndex);
                            break;
                        }
                    }
                }
            }
            
            if (foundIndex === -1 || foundIndex < 0) {
                console.error('인덱스를 찾을 수 없습니다. item:', item);
                showResult('해당 회원을 데이터에서 찾을 수 없습니다.', 'error');
                return;
            }
            
            // 인덱스 범위 확인
            if (foundIndex >= memberData.length) {
                console.error('인덱스가 범위를 벗어났습니다:', foundIndex, 'memberData.length:', memberData.length);
                showResult('행 번호가 잘못되었습니다.', 'error');
                return;
            }
            
            currentEditRowIndex = foundIndex;
            
            // 원본 rowData를 JSON으로 저장 (저장 시 정확한 행 찾기용)
            document.getElementById('originalRowData').value = JSON.stringify(row);
            
            console.log('=== 편집 폼 열기 ===');
            console.log('편집할 행 인덱스:', currentEditRowIndex);
            console.log('원본 rowData:', row);
            console.log('memberData[foundIndex]:', memberData[foundIndex]);
            console.log('회원 정보:', {
                지역: row[0],
                업소명: row[1],
                이름: row[4],
                memberData_확인: memberData[foundIndex] ? {
                    지역: memberData[foundIndex][0],
                    업소명: memberData[foundIndex][1],
                    이름: memberData[foundIndex][4]
                } : '없음'
            });

            // 컬럼: 지역-A(0), 업소명-B(1), 주소-C(2), 전화번호-D(3), 이름-E(4), 회비-F(5), 티켓-G(6), 참석인원-H(7), 수금방식-I(8), 수금자-J(9)
            document.getElementById('editRegion').textContent = row[0] || '';
            document.getElementById('editStore').textContent = row[1] || '';
            document.getElementById('editName').textContent = row[4] || '';

            document.getElementById('feeInput').value = row[5] || '';
            document.getElementById('ticketInput').value = row[6] || '';
            document.getElementById('attendInput').value = row[7] || '';
            document.getElementById('payMethodInput').value = row[8] || '';
            document.getElementById('collectorInput').value = row[9] || '';

            document.getElementById('editPanel').classList.remove('hidden');
        }

        // Google Sheets에 저장
        async function saveToGoogleSheets() {
            if (!GOOGLE_APPS_SCRIPT_URL) {
                alert('Google Apps Script URL이 설정되지 않았습니다.');
                return;
            }

            // 원본 rowData 가져오기
            const originalRowDataStr = document.getElementById('originalRowData').value;
            if (!originalRowDataStr) {
                showResult('원본 데이터를 찾을 수 없습니다. 회원을 다시 클릭해주세요.', 'error');
                return;
            }

            let originalRowData;
            try {
                originalRowData = JSON.parse(originalRowDataStr);
            } catch (e) {
                console.error('원본 데이터 파싱 오류:', e);
                showResult('원본 데이터 오류가 발생했습니다.', 'error');
                return;
            }

            const fee = document.getElementById('feeInput').value;
            const ticket = document.getElementById('ticketInput').value;
            const attend = document.getElementById('attendInput').value;
            const payMethod = document.getElementById('payMethodInput').value;
            const collector = document.getElementById('collectorInput').value;

            // 원본 rowData를 사용하여 memberData에서 정확한 행 찾기
            let exactRowIndex = -1;
            console.log('=== 저장 시작 ===');
            console.log('원본 rowData:', originalRowData);
            
            // 원본 rowData와 정확히 일치하는 행 찾기 (지역, 업소명, 주소, 전화번호, 이름으로 비교)
            for (let i = 0; i < memberData.length; i++) {
                if (Array.isArray(memberData[i]) && memberData[i].length >= 5) {
                    // 지역, 업소명, 주소, 전화번호, 이름이 모두 일치하는지 확인
                    const match = 
                        String(memberData[i][0] || '').trim() === String(originalRowData[0] || '').trim() &&
                        String(memberData[i][1] || '').trim() === String(originalRowData[1] || '').trim() &&
                        String(memberData[i][2] || '').trim() === String(originalRowData[2] || '').trim() &&
                        String(memberData[i][3] || '').trim() === String(originalRowData[3] || '').trim() &&
                        String(memberData[i][4] || '').trim() === String(originalRowData[4] || '').trim();
                    
                    if (match) {
                        exactRowIndex = i;
                        console.log('정확한 행 찾음:', exactRowIndex, '회원:', memberData[i][1], memberData[i][4]);
                        break;
                    }
                }
            }
            
            if (exactRowIndex === -1) {
                console.error('원본 rowData와 일치하는 행을 찾을 수 없습니다.');
                console.error('원본:', originalRowData);
                console.error('memberData 샘플:', memberData.slice(0, 3));
                showResult('해당 회원을 데이터에서 찾을 수 없습니다. 데이터를 새로고침해주세요.', 'error');
                return;
            }

            // currentMember를 먼저 가져오기 (사용 전에 정의)
            const currentMember = memberData[exactRowIndex];
            
            if (!currentMember) {
                console.error('memberData에서 해당 인덱스를 찾을 수 없습니다:', exactRowIndex);
                showResult('데이터 오류: 해당 회원을 찾을 수 없습니다.', 'error');
                return;
            }
            
            // Google Sheets의 실제 행 번호 계산
            // 헤더가 제거되었으면: 헤더(1행) + 데이터(memberData[0] = 2행)
            // 헤더가 제거되지 않았으면: memberData[0] = 1행
            // 하지만 더 정확하게는: 헤더가 있으면 +1, 없으면 +0
            // memberData는 헤더를 제거했으므로 항상 +2 (헤더 1행 + 데이터 시작)
            const sheetRow = exactRowIndex + 2;
            
            console.log('=== 행 번호 계산 ===');
            console.log('헤더 제거 여부:', headerRemoved);
            console.log('정확한 행 인덱스 (memberData 기준):', exactRowIndex);
            console.log('계산된 Google Sheets 행 번호:', sheetRow);
            console.log('회원 정보로 검증:', {
                지역: currentMember[0],
                업소명: currentMember[1],
                이름: currentMember[4]
            });
            console.log('저장할 회원 정보 (memberData에서):', {
                지역: currentMember[0],
                업소명: currentMember[1],
                주소: currentMember[2],
                전화번호: currentMember[3],
                이름: currentMember[4],
                행번호: sheetRow
            });
            
            // 편집 폼에 표시된 정보와 비교
            const formStore = document.getElementById('editStore').textContent;
            const formName = document.getElementById('editName').textContent;
            console.log('편집 폼에 표시된 정보:', {
                업소명: formStore,
                이름: formName
            });
            
            // 일치 여부 확인
            if (String(currentMember[1] || '').trim() !== formStore.trim() || 
                String(currentMember[4] || '').trim() !== formName.trim()) {
                console.warn('⚠️ 경고: 편집 폼의 정보와 memberData의 정보가 일치하지 않습니다!');
                console.warn('memberData:', currentMember[1], currentMember[4]);
                console.warn('편집 폼:', formStore, formName);
            }
            
            if (exactRowIndex < 0) {
                showResult('행 번호가 잘못되었습니다. 회원을 다시 클릭해주세요.', 'error');
                return;
            }
            
            // sheetRow가 유효한 숫자인지 엄격하게 확인
            const sheetRowNum = Number(sheetRow);
            if (isNaN(sheetRowNum) || !isFinite(sheetRowNum) || sheetRowNum < 2) {
                console.error('❌ 잘못된 행 번호:', {
                    sheetRow: sheetRow,
                    sheetRowNum: sheetRowNum,
                    exactRowIndex: exactRowIndex,
                    headerRemoved: headerRemoved,
                    currentMember: currentMember
                });
                showResult('행 번호 계산 오류가 발생했습니다. (계산된 행: ' + sheetRow + ')', 'error');
                return;
            }
            
            // 유효한 숫자로 재할당
            const validSheetRow = Math.floor(sheetRowNum); // 정수로 변환
            
            console.log('✅ 최종 확인 - 저장할 행:', {
                exactRowIndex: exactRowIndex,
                sheetRow: validSheetRow,
                sheetRow_타입: typeof validSheetRow,
                회원: currentMember[1] + ' / ' + currentMember[4],
                지역: currentMember[0],
                업소명: currentMember[1],
                이름: currentMember[4]
            });

            // 사용자 확인
            const confirmMessage = `다음 회원 정보에 저장하시겠습니까?\n\n` +
                `지역: ${currentMember[0]}\n` +
                `업소명: ${currentMember[1]}\n` +
                `이름: ${currentMember[4]}\n` +
                `Google Sheets 행 번호: ${validSheetRow}\n\n` +
                `회비: ${fee || '(비어있음)'}\n` +
                `티켓: ${ticket || '(비어있음)'}\n` +
                `참석인원: ${attend || '(비어있음)'}\n` +
                `수금방식: ${payMethod || '(비어있음)'}\n` +
                `수금자: ${collector || '(비어있음)'}`;
            
            if (!confirm(confirmMessage)) {
                console.log('사용자가 저장을 취소했습니다.');
                return;
            }

            const payload = {
                row: sheetRow,
                fee,
                ticket,
                attend,
                payMethod,
                collector,
                // 디버깅용: 저장할 회원 정보도 함께 전달
                storeName: currentMember[1],
                memberName: currentMember[4],
                region: currentMember[0]
            };
            
            console.log('📤 Google Apps Script에 전달할 데이터:', payload);

            try {
                showLoading(true);
                
                // GET 방식으로 쿼리 파라미터 사용 (CORS 문제 해결)
                // row 값을 명시적으로 문자열로 변환하여 전달 (NaN 방지)
                // 회원 정보도 함께 전달하여 Google Apps Script에서 검증 가능하도록
                const params = new URLSearchParams({
                    row: String(validSheetRow), // 유효한 숫자를 문자열로 변환
                    fee: String(fee || ''),
                    ticket: String(ticket || ''),
                    attend: String(attend || ''),
                    payMethod: String(payMethod || ''),
                    collector: String(collector || ''),
                    // 회원 정보 (Google Apps Script에서 검증 및 행 찾기용)
                    region: String(currentMember[0] || ''),      // A: 지역
                    storeName: String(currentMember[1] || ''),   // B: 업소명
                    address: String(currentMember[2] || ''),      // C: 주소
                    phone: String(currentMember[3] || ''),        // D: 전화번호
                    memberName: String(currentMember[4] || '')   // E: 이름
                });
                
                // POST + application/x-www-form-urlencoded 사용 (Apps Script가 e.parameter에 넣어줌 → K열 날짜 기록 가능)
                const postBody = params.toString();
                console.log('📤 Google Apps Script에 POST 전달, row:', String(validSheetRow));
                
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: postBody
                }).catch(async () => {
                    // POST 실패 시 GET으로 재시도 (URL 길이 제한 있음)
                    const url = `${GOOGLE_APPS_SCRIPT_URL}?${postBody}`;
                    return await fetch(url, { method: 'GET', mode: 'no-cors' });
                });

                // no-cors 모드에서는 응답을 확인할 수 없으므로, 성공으로 간주
                // 로컬 데이터 업데이트 (정확한 행 인덱스 사용)
                if (!memberData[exactRowIndex]) {
                    memberData[exactRowIndex] = [];
                }
                memberData[exactRowIndex][5] = fee;
                memberData[exactRowIndex][6] = ticket;
                memberData[exactRowIndex][7] = attend;
                memberData[exactRowIndex][8] = payMethod;
                memberData[exactRowIndex][9] = collector;
                
                // currentEditRowIndex도 업데이트
                currentEditRowIndex = exactRowIndex;

                // 캐시 무효화
                const sheetId = '1VO1J_ShBYQWBOt_NKLpK4xhlaqcCqjV5PNpspDrA5mI';
                const CACHE_KEY = `sheets_data_${sheetId}`;
                try {
                    localStorage.removeItem(CACHE_KEY);
                } catch (e) {
                    console.log('캐시 삭제 실패:', e);
                }
                
                showLoading(false);
                showResult('Google Sheets에 저장되었습니다. (응답 확인 불가 - 저장되었을 가능성이 높습니다)', 'success');
                
                // 1초 후 데이터 새로고침 (더 빠르게)
                setTimeout(() => {
                    loadGoogleSheets();
                }, 1000);
                
            } catch (error) {
                console.error('저장 오류:', error);
                showLoading(false);
                showResult('Google Sheets 저장 중 오류가 발생했습니다: ' + error.message + '. Google Apps Script 배포 설정을 확인해주세요.', 'error');
            }
        }

        // QR 코드 스캐너 열기
        async function openQRScanner() {
            const modal = document.getElementById('qrModal');
            const statusDiv = document.getElementById('qr-status');
            
            modal.classList.add('active');
            statusDiv.className = 'qr-status scanning';
            statusDiv.textContent = '카메라를 시작하는 중...';

            try {
                // html5-qrcode 스캐너 초기화
                html5QrcodeScanner = new Html5Qrcode("qr-reader");
                
                // 스캔 시작
                await html5QrcodeScanner.start(
                    {
                        facingMode: "environment" // 후면 카메라 우선
                    },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    (decodedText, decodedResult) => {
                        // QR 코드 스캔 성공
                        onQRCodeScanned(decodedText);
                    },
                    (errorMessage) => {
                        // 스캔 중 오류 (일반적으로 무시)
                        // statusDiv.textContent = '스캔 중...';
                    }
                );
                
                statusDiv.className = 'qr-status scanning';
                statusDiv.textContent = 'QR 코드를 카메라에 맞춰주세요';
                isQRScannerRunning = true; // 스캐너 실행 중 표시
            } catch (error) {
                console.error('QR 스캐너 시작 오류:', error);
                statusDiv.className = 'qr-status error';
                statusDiv.textContent = '카메라 접근 권한이 필요합니다. 브라우저 설정에서 카메라 권한을 허용해주세요.';
                isQRScannerRunning = false;
            }
        }

        // QR 코드 스캔 완료 처리
        async function onQRCodeScanned(decodedText) {
            const statusDiv = document.getElementById('qr-status');
            const scannedText = decodedText.trim();
            
            console.log('QR 코드 스캔 완료:', scannedText);
            
            // 스캐너 먼저 중지 (중복 스캔 방지)
            await stopQRScannerSafely();
            
            // 스캔된 텍스트를 검색 입력란에 넣기
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = scannedText;
                // 입력 이벤트 트리거 (일부 브라우저에서 필요)
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                searchInput.dispatchEvent(new Event('change', { bubbles: true }));
                console.log('검색 입력란에 값 설정 완료:', searchInput.value);
            } else {
                console.error('검색 입력란을 찾을 수 없습니다.');
            }
            
            statusDiv.className = 'qr-status success';
            statusDiv.textContent = 'QR 코드 스캔 완료: ' + scannedText;
            
            // 모달 닫기
            const modal = document.getElementById('qrModal');
            modal.classList.remove('active');
            statusDiv.className = 'qr-status scanning';
            statusDiv.textContent = '카메라를 시작하는 중...';
            
            // 약간의 지연 후 검색 실행 (입력값이 확실히 설정되도록)
            setTimeout(() => {
                console.log('검색 실행, 입력값:', document.getElementById('searchInput').value);
                searchMember();
            }, 100);
        }

        // QR 스캐너 안전하게 중지하는 함수
        async function stopQRScannerSafely() {
            if (html5QrcodeScanner && isQRScannerRunning) {
                try {
                    await html5QrcodeScanner.stop();
                    console.log('QR 스캐너 중지됨');
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                    isQRScannerRunning = false;
                } catch (err) {
                    // 스캐너가 이미 중지되었거나 실행 중이 아닌 경우 무시
                    if (err.message && err.message.includes('not running')) {
                        console.log('QR 스캐너가 이미 중지되었습니다.');
                    } else {
                        console.error('QR 스캐너 중지 오류:', err);
                    }
                    // 정리 작업
                    try {
                        html5QrcodeScanner.clear();
                    } catch (clearErr) {
                        // clear 오류는 무시
                    }
                    html5QrcodeScanner = null;
                    isQRScannerRunning = false;
                }
            }
        }

        // QR 코드 스캐너 닫기
        async function closeQRScanner() {
            const modal = document.getElementById('qrModal');
            const statusDiv = document.getElementById('qr-status');
            
            // 스캐너 안전하게 중지
            await stopQRScannerSafely();
            
            modal.classList.remove('active');
            statusDiv.className = 'qr-status scanning';
            statusDiv.textContent = '카메라를 시작하는 중...';
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('service-worker.js')
            .then(() => console.log('Service Worker 등록 성공'))
            .catch(err => console.error('SW 등록 실패', err));
        }
        </script>
        
</body>
</html>